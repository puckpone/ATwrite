from openai import OpenAI
import os
import re
import time

#  API Key
API_KEY = ""

# DeepSeek API é…ç½®
client = OpenAI(api_key=API_KEY, base_url="")

# å°è¯´è®¾å®š
NOVEL_FILE = "novel.txt"
OVERVIEW_FILE = "overview.txt"  # æ–°å¢æ¦‚è¦æ–‡ä»¶
NOVEL_TITLE = "ä»™é€”å¥‡ç¼˜å½•"
WORD_LIMIT = 330000  # 66ç«  x 5000å­—
WORDS_PER_CHAPTER = 5000  # æ¯ç« 5000æ±‰å­—
CONTEXT_LENGTH = 1500  # åˆå§‹ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œé˜²æ­¢ input è¿‡é•¿
MAX_RETRIES = 10      # æ¯ç« æœ€å¤§é‡è¯•æ¬¡æ•°

# åŠ¨æ€ sleep å˜é‡
sleep_time = 20
sleep_levels = [20, 30, 40, 60, 120, 180, 300]  # å¤±è´¥æ—¶é€æ­¥å¢åŠ  sleep æ—¶é—´
error_counts = {"20034": 0, "20035": 0, "20059": 0}  # è®°å½•å„é”™è¯¯æ¬¡æ•°

# å°è¯´èƒŒæ™¯è®¾å®šï¼ˆç„å¹»/ä¿®çœŸé¢˜æï¼Œè¯¦ç»†è®¾å®šï¼‰
NOVEL_BACKGROUND = """
ã€Šä»™é€”å¥‡ç¼˜å½•ã€‹è®²è¿°äº†ä¸€ä¸ªå‡¡äººæ„å¤–è·å¾—ä¸Šå¤ä¼ æ‰¿ï¼Œè¸å…¥ä¿®çœŸä¸–ç•Œï¼Œå†ç»æ— æ•°è‰°é™©ä¸ç£¨éš¾ï¼Œæœ€ç»ˆç¾½åŒ–ç™»ä»™çš„ä¼ å¥‡å†ç¨‹ã€‚ä»¥ä¸‹æ˜¯æœ¬ä¹¦çš„è¯¦ç»†è®¾å®šï¼š

ğŸ”¹ **ä¸–ç•ŒèƒŒæ™¯**ï¼š
æ•…äº‹å‘ç”Ÿåœ¨ä¸€ä¸ªåä¸ºâ€œç„è‹ç•Œâ€çš„æµ©æ¸ºå¤©åœ°ï¼Œçµæ°”å¼¥æ¼«ï¼Œå±±å·å¼‚å½©ï¼Œåˆ†ä¸ºäº”å¤§é™†åŸŸï¼ˆä¸œç„ã€å—è’ã€è¥¿æ¼ ã€åŒ—å¯’ã€ä¸­å·ï¼‰ï¼Œå„å…·ç‰¹è‰²ã€‚ä¿®çœŸæ–‡æ˜é«˜åº¦å‘è¾¾ï¼Œå‡¡äººã€ä¿®å£«ã€å¦–å…½å…±å­˜ï¼Œå¤©å¤–é­”åŸŸéšç°ï¼Œå±æœºå››ä¼ã€‚

ğŸ”¹ **ä¸»è¦äººç‰©**ï¼š
1. **æŸ³å°˜**ï¼šä¸»è§’ï¼Œå‡¡äººå‡ºèº«ï¼Œå› æœºç¼˜è·ã€Šæ··æ²Œä»™è¯€ã€‹ï¼Œä»å¹³å‡¡å°‘å¹´æˆé•¿ä¸ºä¿®çœŸé¡¶å³°ä¹‹äººã€‚åšéŸ§æœæ•¢ï¼Œå¿ƒæ€€ä»ä¹‰ã€‚
2. **å†·é”‹**ï¼šå‰‘ä¿®ï¼Œæœºæ™ºå†·å³»ï¼Œæ“…ç”¨â€œå¯’å½±å‰‘æ³•â€ï¼Œä¸æŸ³å°˜ç»“ä¸ºç”Ÿæ­»å…„å¼Ÿã€‚
3. **äº‘ç‘¶**ï¼šä¸¹å¸ˆï¼Œæ¸©æŸ”åšæ¯…ï¼Œå¤©èµ‹å¼‚ç¦€ï¼Œç²¾é€šç‚¼ä¸¹ä¸ç–—ä¼¤ï¼Œæ˜¯å›¢é˜Ÿçš„çµé­‚æ”¯æŸ±ã€‚
4. **ç„é˜µå­**ï¼šé˜µæ³•å¸ˆï¼Œèº«æ€€ç»æŠ€ï¼ŒæŒæ¡â€œä¹å¤©ç„é˜µâ€ï¼Œè¶³æ™ºå¤šè°‹ï¼Œæ€§æƒ…å­¤åƒ»ã€‚
5. **é­”çš‡è‹å†¥**ï¼šåæ´¾é¢†è¢–ï¼Œé‚ªä¿®ä¹‹ç‹ï¼Œå†·é…·æ®‹å¿ï¼Œæ¬²ä»¥â€œå¤©é­”è¡€ç¥­â€é¢ è¦†æ­£é“ã€‚
6. **å…¶ä»–äººç‰©**ï¼šä»™é—¨æŒæ•™å‡Œéœ„å­ï¼ˆæ­£é“é¢†è¢–ï¼‰ã€å¦–ç‹èµ¤ç„°ï¼ˆä¸­ç«‹åŠ¿åŠ›ï¼‰ã€é­”å¥³ç´«é¸¢ï¼ˆé˜´é™©ç‹¡è¯ˆï¼‰ç­‰ã€‚

ğŸ”¹ **é‡è¦ä¹¦ç±/æ–‡çŒ®**ï¼š
1. **ã€Šæ··æ²Œä»™è¯€ã€‹**ï¼šä¸Šå¤ä¼ æ‰¿ï¼ŒæŸ³å°˜æ ¸å¿ƒåŠŸæ³•ï¼Œè•´å«æ··æ²Œä¹‹åŠ›ï¼Œè´¯ç©¿å…¨ä¹¦ã€‚
2. **ã€Šå¤©ä¸¹å½•ã€‹**ï¼šäº‘ç‘¶éšèº«ä¹‹ç‰©ï¼Œè®°å½•ç‚¼ä¸¹ç§˜æœ¯ï¼ŒåŠ©å›¢é˜Ÿæ¸¡åŠ«ç–—ä¼¤ã€‚
3. **ã€Šç„é˜µæ®‹è°±ã€‹**ï¼šç„é˜µå­æ‰€å¾—ï¼Œè®°è½½å¤±ä¼ é˜µæ³•ï¼Œæ˜¯ç ´æ•Œå…³é”®ã€‚

ğŸ”¹ **åŠ¿åŠ›ä¸ç»„ç»‡**ï¼š
1. **æ­£é“ä»™ç›Ÿ**ï¼šä»¥å‡Œéœ„å®—ä¸ºé¦–ï¼Œç»´æŠ¤ä¿®çœŸç•Œå’Œå¹³ã€‚
2. **å¤©é­”æ•™**ï¼šé‚ªä¿®åŠ¿åŠ›ï¼Œé‡å¿ƒå‹ƒå‹ƒï¼Œæ¬²æŸ“æŒ‡å¤©ä¸‹ã€‚
3. **å¦–æ—è”ç›Ÿ**ï¼šå¦–å…½æ—ç¾¤ï¼Œä¸­ç«‹åä¹±ï¼Œä¼ºæœºæ‰©å¼ ã€‚
4. **æ•£ä¿®ä¼š**ï¼šæ— é—¨æ´¾ä¿®å£«è”åˆï¼ŒåŠ¿åŠ›åˆ†æ•£ä½†æ½œåŠ›å·¨å¤§ã€‚

ğŸ”¹ **æˆ˜æ–—æ–¹å¼**ï¼š
1. **çµåŠ›æˆ˜**ï¼šä»¥çµæ°”é©±åŠ¨åŠŸæ³•ã€æ³•å®ï¼Œå‰‘æ°”ã€æŒé£ã€ç¬¦ç®“ä¸ºä¸»ã€‚
2. **é˜µæ³•æˆ˜**ï¼šå¸ƒé˜µå›°æ•Œæˆ–å¢ç›Šå·±æ–¹ï¼Œç„é˜µå­æ“…ç”¨ã€‚
3. **ä¸¹è¯æˆ˜**ï¼šäº‘ç‘¶ä»¥ä¸¹è¯æå‡æˆ˜åŠ›æˆ–å‰Šå¼±æ•Œäººã€‚
4. **æ³•å®**ï¼šé£å‰‘ï¼ˆå¯’å½±å‰‘ï¼‰ã€ä¸¹ç‚‰ï¼ˆå¤©ç«ç‚‰ï¼‰ã€é˜µç›˜ï¼ˆç„å¤©ç›˜ï¼‰ï¼Œç§ç±»æœ‰é™ã€‚

ğŸ”¹ **å‡çº§ä½“ç³»**ï¼š
1. **å¢ƒç•Œåˆ’åˆ†**ï¼šç‚¼æ°”ã€ç­‘åŸºã€é‡‘ä¸¹ã€å…ƒå©´ã€åŒ–ç¥ã€åˆé“ã€æ¸¡åŠ«ã€å¤§ä¹˜ã€é£å‡ä¹é˜¶ï¼Œæ¯é˜¶åˆ†åˆã€ä¸­ã€åæœŸã€‚
2. **çµåŠ›å‡çº§**ï¼šé€šè¿‡ä¿®ç‚¼ã€Šæ··æ²Œä»™è¯€ã€‹ã€åå™¬çµçŸ³ã€å¸æ”¶å¤©åœ°çµæ°”æå‡ã€‚
3. **å¿ƒå¢ƒå‡çº§**ï¼šå†ç»ç”Ÿæ­»ã€å¿ƒé­”è¯•ç‚¼ï¼Œé¢†æ‚Ÿå¤§é“çœŸè°›ã€‚
4. **å›¢é˜Ÿå‡çº§**ï¼šå››äººåä½œï¼ŒåŠŸæ³•äº’è¡¥ï¼Œæˆ˜åŠ›å åŠ ã€‚

ğŸ”¹ **æ ¸å¿ƒå‰§æƒ…**ï¼š
æŸ³å°˜åœ¨å±±æ‘å¶å¾—ã€Šæ··æ²Œä»™è¯€ã€‹ï¼Œå› ä½“å†…æ··æ²Œä¹‹åŠ›è§‰é†’ï¼Œå¼•æ¥æ­£é‚ªä¸¤é“å…³æ³¨ã€‚ä»–ä¸å†·é”‹ã€äº‘ç‘¶ã€ç„é˜µå­ç»“ä¼´ï¼Œä»å¦–å…½è‚†è™çš„å—è’å‡ºå‘ï¼Œå†ç»ä»™ç›Ÿè¯•ç‚¼ã€å¤©é­”æ•™å›´å‰¿ï¼Œé€æ­¥æ­å¼€æ··æ²Œä¹‹åŠ›çš„ç§˜å¯†ã€‚é­”çš‡è‹å†¥æ¬²ä»¥â€œå¤©é­”è¡€ç¥­â€é‡å¡‘ç„è‹ç•Œï¼ŒæŸ³å°˜åœ¨å¤ä»‡ä¸æ‹¯æ•‘é—´æŠ‰æ‹©ï¼Œæœ€ç»ˆå¯¹å†³è‹å†¥ï¼Œé£å‡ä»™ç•Œã€‚

ğŸ”¹ **ä¸»é¢˜ä¸é£æ ¼**ï¼š
å°è¯´èåˆæƒŠé™©æˆ˜æ–—ã€æ¸©æƒ…ç¾ç»Šä¸å“²ç†æ€ç´¢ï¼Œå±•ç°ä¿®çœŸè€…åœ¨é€†å¢ƒä¸­ç£¨ç ºå¿ƒå¿—ã€è¶…è„±å‡¡å°˜çš„ç²¾ç¥è¿½æ±‚ï¼Œå…¼å…·å”¯ç¾ä¸æ®‹é…·ã€‚
"""

# ç« èŠ‚å¤§çº²ï¼ˆå…±66ç« ï¼Œä¿®çœŸç„å¹»é¢˜æï¼‰
CHAPTERS = [
    "çµæ ¹åˆå¯", "å‡¡å°˜èµ·æ­¥", "ä»™ç¼˜åˆç°", "å‘½è¿è½¬æœº", "æ´å¤©ç§˜å¢ƒ", "çµè„‰è§‰é†’", "å‰‘æ°”çºµæ¨ª", "å¦–å…½æ¥è¢­",
    "é€†å¤©è¯•ç‚¼", "å¤©ç½¡é™ä¸´", "çµä¸¹å¦™è¯", "çµå±±ä¹‹å·…", "é“å¿ƒåˆæˆ", "ç»å¢ƒæ±‚ç”Ÿ", "ä»™æ³•ä¼ æ‰¿", "å¦–é­”ä¹±ä¸–",
    "ç§˜æœ¯æ¢ç§˜", "ç¥å…½é™ä¸–", "å¤©ç•Œå¬å”¤", "å¤©æœºæµè½¬", "ç ´è™šæ–©é­”", "å‰‘å½±è¿·è¸ª", "çµé­‚å‡€åŒ–", "å…ƒå©´å¢ƒç•Œ",
    "å¦–æ°”ç¼ èº«", "è‹ç©¹è£‚å˜", "ä»™è·¯åå·", "å‰‘é—¨äº‰é”‹", "ç„å†°è¯€æ³•", "è¡€è„‰å¥‡ç¼˜", "çƒˆç«çœŸä¼ ", "æ˜Ÿæ²³å€’å½±",
    "é­”åŸŸé‡ç”Ÿ", "çµè„‰é£æš´", "å¤©é“è¯•ç‚¼", "é­‚é­„å½’ä½", "å¤ç±é—ç§˜", "é£äº‘é™…ä¼š", "çœŸå…ƒçˆ†å‘", "ä¸¹è¯å¥‡æ•ˆ",
    "ç§˜å¢ƒæ¢é™©", "å¹»å½±é‡é‡", "å®¿å‘½ä¹‹äº‰", "ç¥å…‰ä¹ç°", "é€†å¢ƒé£å‡", "ä»™é­”å¤§æˆ˜", "ä¹å¤©è¯€ç ´", "å¿ƒé­”è¿·å¢ƒ",
    "ä¿®ç½—æˆ˜åœº", "ç¥ç§˜åœ£åŸŸ", "å‰‘ä»™å½’æ¥", "é‡é“¸å¤©å‘½", "æ··æ²Œåˆå¼€", "å¤©åŠ«é™ä¸´", "ä»™ç¼˜æ— åŒ", "æ˜Ÿè¾°å¤§æµ·",
    "å¹»å¢ƒçœŸç« ", "å°˜åŸƒè½å®š", "ä¸‡æ³•å½’å®—", "çµé­‚è§‰é†’", "é€†è½¬ä¹¾å¤", "å¤©é“è½®å›", "å‚²è§†è‹ç©¹", "ä»™ç•Œä¹‹é—¨",
    "æé“å·…å³°", "æ°¸æ’ä»™é€”"
]

def get_last_context():
    """è·å–æ–‡ä»¶æœ«å°¾ CONTEXT_LENGTH ä¸ªæ±‰å­—ä½œä¸ºä¸Šä¸‹æ–‡"""
    if not os.path.exists(NOVEL_FILE):
        return ""
    with open(NOVEL_FILE, "r", encoding="utf-8") as f:
        text = f.read()
    return text[-CONTEXT_LENGTH:] if len(text) > CONTEXT_LENGTH else text

def count_chinese_characters(text):
    """ç»Ÿè®¡æ–‡æœ¬ä¸­çš„æ±‰å­—æ•°é‡"""
    return len(re.findall(r'[\u4e00-\u9fff]', text))

def get_chapter_content(chapter_number):
    """è·å–æŒ‡å®šç« èŠ‚çš„å…¨éƒ¨å†…å®¹"""
    if not os.path.exists(NOVEL_FILE):
        return ""
    with open(NOVEL_FILE, "r", encoding="utf-8") as f:
        content = f.read()
    chapter_pattern = fr"### ç¬¬{chapter_number}ç« .*?\n\n(.*?)(?=(### ç¬¬\d+ç« |\Z))"
    match = re.search(chapter_pattern, content, re.DOTALL)
    return match.group(1).strip() if match else ""

def get_latest_chapter_number():
    """æ ¹æ®æ–‡ä»¶å†…å®¹åˆ¤æ–­å½“å‰å·²ç”Ÿæˆçš„ç« èŠ‚æ•°é‡"""
    if not os.path.exists(NOVEL_FILE):
        return 1
    with open(NOVEL_FILE, "r", encoding="utf-8") as f:
        content = f.read()
    matches = re.findall(r"### ç¬¬(\d+)ç« ", content)
    return max(map(int, matches)) + 1 if matches else 1

def get_all_overviews():
    """è¯»å– overview.txt ä¸­çš„æ‰€æœ‰æ¦‚è¦å†…å®¹"""
    if not os.path.exists(OVERVIEW_FILE):
        return ""
    with open(OVERVIEW_FILE, "r", encoding="utf-8") as f:
        return f.read()

def generate_chapter(chapter_number):
    """ç”Ÿæˆç« èŠ‚ï¼ŒæŒç»­ç”Ÿæˆç›´åˆ°è¾¾åˆ°5000æ±‰å­—ï¼ŒåŒæ—¶ç”Ÿæˆæ¦‚è¦"""
    chapter_title_line = f"### ç¬¬{chapter_number}ç«  {CHAPTERS[chapter_number - 1]}"
    print(f"\nğŸ“ æ­£åœ¨ç”Ÿæˆ {chapter_title_line} ...")
    retries = 0
    first_chunk = True  # æ ‡è®°æ˜¯å¦ä¸ºç¬¬ä¸€æ¬¡è°ƒç”¨

    while True:
        # è·å–å½“å‰ç« èŠ‚å·²æœ‰å†…å®¹å¹¶æ£€æŸ¥å­—æ•°
        current_content = get_chapter_content(chapter_number)
        current_word_count = count_chinese_characters(current_content)
        if current_word_count >= WORDS_PER_CHAPTER:
            print(f"âœ… {chapter_title_line} å·²å®Œæˆï¼Œå­—æ•°ï¼š{current_word_count}")
            return  # å­—æ•°è¾¾æ ‡ï¼Œé€€å‡ºç”Ÿæˆ

        print(f"å½“å‰å­—æ•°ï¼š{current_word_count}/{WORDS_PER_CHAPTER}ï¼Œç»§ç»­ç»­å†™...")
        retries = 0  # é‡ç½®é‡è¯•è®¡æ•°

        while retries < MAX_RETRIES:
            try:
                context = get_last_context()
                all_overviews = get_all_overviews()  # è·å–å·²æœ‰æ¦‚è¦
                if first_chunk:
                    # ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶åŒ…å«ç« èŠ‚æ ‡é¢˜ä¿¡æ¯å’Œè¯¦ç»†è®¾å®š
                    prompt = f"""ä½ æ˜¯ä¸€ä½é¡¶çº§çš„ä¿®çœŸå°è¯´å®¶ï¼Œç°åœ¨æ­£åœ¨åˆ›ä½œä¸€æœ¬ç„å¹»ä¿®çœŸé¢˜æçš„å°è¯´ã€Š{NOVEL_TITLE}ã€‹ã€‚
è¯·æ ¹æ®ä»¥ä¸‹è®¾å®šå’Œå·²æœ‰å†…å®¹ç»­å†™æœ¬ç« å†…å®¹ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªçº¦100å­—çš„æ¦‚è¦ï¼š

ğŸ”¹ **å°è¯´èƒŒæ™¯è®¾å®š**ï¼š
{NOVEL_BACKGROUND}

ğŸ”¹ **å·²æœ‰å‰§æƒ…æ¦‚è¦**ï¼ˆè¯·ç¡®ä¿å‰§æƒ…è¿è´¯ï¼‰ï¼š
{all_overviews}

ğŸ”¹ **æœ¬ç« èŠ‚æ ‡é¢˜**ï¼š
{chapter_title_line}

ğŸ”¹ **ä¸Šä¸€ç« èŠ‚å†…å®¹**ï¼ˆè¯·å‚è€ƒï¼Œä½†é¿å…å‰§æƒ…é‡å¤ï¼‰ï¼š
{context}

ğŸ”¹ **ç« èŠ‚å†™ä½œè¦æ±‚**ï¼š
1. ä¸¥æ ¼æŒ‰ç…§ç« èŠ‚æ ‡é¢˜å’Œå·²æœ‰æ¦‚è¦æ¨è¿›å‰§æƒ…ï¼Œä¸è¦è·³è·ƒå¼å‘å±•ï¼›
2. ä¿æŒä¿®çœŸç„å¹»ä¸çœŸå®äººæ€§äº¤ç»‡çš„é£æ ¼ï¼›
3. ç”Ÿæˆå†…å®¹ä¸­ä¸è¦é‡å¤ç« èŠ‚æ ‡é¢˜ï¼›
4. è¯·ç”Ÿæˆç»­å†™å†…å®¹ï¼Œç›´æ¥æ¥ç»­ä¸Šæ–‡ï¼Œä¸éœ€è¦å†æ·»åŠ ç« èŠ‚æ ‡é¢˜ï¼›
5. æœ¬æ¬¡ç”Ÿæˆçš„å†…å®¹ç›´æ¥å†™å…¥æ–‡ä»¶ï¼›
6. ç”Ÿæˆå†…å®¹ä¸å°äº5000ä¸ªæ±‰å­—ï¼Œæ³¨æ„å­—æ•°è¦æ±‚ï¼

ğŸ”¹ **æ¦‚è¦è¦æ±‚**ï¼š
1. ç”Ÿæˆä¸€ä¸ªçº¦100å­—çš„æ¦‚è¦ï¼Œæ€»ç»“æœ¬ç« æ ¸å¿ƒå‰§æƒ…ï¼›
2. æ¦‚è¦ä¸åŒ…å«æ ‡é¢˜ï¼Œç›´æ¥å†™å…¥ overview.txt æ–‡ä»¶ã€‚

âœï¸ è¯·ä»¥ä»¥ä¸‹æ ¼å¼è¿”å›ï¼š
æ­£æ–‡ï¼š
[ç»­å†™å†…å®¹]
æ¦‚è¦ï¼š
[çº¦100å­—çš„æ¦‚è¦]
"""
                else:
                    # åç»­è°ƒç”¨æ—¶ï¼Œä¸å†åŒ…å«ç« èŠ‚æ ‡é¢˜
                    prompt = f"""ä½ æ˜¯ä¸€ä½é¡¶çº§çš„ä¿®çœŸå°è¯´å®¶ï¼Œç°åœ¨æ­£åœ¨ç»­å†™ç„å¹»ä¿®çœŸé¢˜æçš„å°è¯´ã€Š{NOVEL_TITLE}ã€‹çš„ç¬¬{chapter_number}ç« ã€‚
è¯·æ ¹æ®ä»¥ä¸‹è®¾å®šå’Œå·²æœ‰å†…å®¹ç»§ç»­å†™ä½œç»­ç¯‡ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªçº¦100å­—çš„æ¦‚è¦ï¼š

ğŸ”¹ **å°è¯´èƒŒæ™¯è®¾å®š**ï¼š
{NOVEL_BACKGROUND}

ğŸ”¹ **å·²æœ‰å‰§æƒ…æ¦‚è¦**ï¼ˆè¯·ç¡®ä¿å‰§æƒ…è¿è´¯ï¼‰ï¼š
{all_overviews}

ğŸ”¹ **ä¸Šä¸€ç« èŠ‚å†…å®¹**ï¼ˆè¯·å‚è€ƒï¼Œä½†é¿å…å‰§æƒ…é‡å¤ï¼‰ï¼š
{context}

ğŸ”¹ **ç»­å†™è¦æ±‚**ï¼š
1. è¯·ç»­å†™ä¸Šæ–‡æƒ…èŠ‚ï¼Œç›´æ¥è¡”æ¥ï¼Œä¸è¦å†æ¬¡ç”Ÿæˆç« èŠ‚æ ‡é¢˜ï¼›
2. ä¿æŒä¿®çœŸç„å¹»ä¸çœŸå®äººæ€§äº¤ç»‡çš„é£æ ¼ï¼›
3. ç”Ÿæˆçš„ç»­å†™å†…å®¹ä¸åº”åŒ…å«å¤šä½™çš„æ ‡é¢˜æˆ–é‡å¤å†…å®¹ï¼›
4. è¯·ç”Ÿæˆç»­å†™éƒ¨åˆ†å†…å®¹ï¼Œç›´æ¥å†™å…¥æ–‡ä»¶ï¼›
5. ç”Ÿæˆå†…å®¹ä¸å°äº5000ä¸ªæ±‰å­—ï¼Œæ³¨æ„å­—æ•°è¦æ±‚ï¼

ğŸ”¹ **æ¦‚è¦è¦æ±‚**ï¼š
1. ç”Ÿæˆä¸€ä¸ªçº¦100å­—çš„æ¦‚è¦ï¼Œæ€»ç»“æœ¬ç« æ ¸å¿ƒå‰§æƒ…ï¼›
2. æ¦‚è¦ä¸åŒ…å«æ ‡é¢˜ï¼Œç›´æ¥å†™å…¥ overview.txt æ–‡ä»¶ã€‚

âœï¸ è¯·ä»¥ä»¥ä¸‹æ ¼å¼è¿”å›ï¼š
æ­£æ–‡ï¼š
[ç»­å†™å†…å®¹]
æ¦‚è¦ï¼š
[çº¦100å­—çš„æ¦‚è¦]
"""
                # è®°å½• DeepSeek API çš„æ€è€ƒå¼€å§‹æ—¶é—´
                think_start_time = time.time()
                print("ğŸ¤” DeepSeek å¼€å§‹æ€è€ƒ...")
                completion = client.chat.completions.create(
                    model="deepseek-r1",
                    messages=[{"role": "user", "content": prompt}],
                    temperature=0.7,
                    max_tokens=WORDS_PER_CHAPTER * 4 // 3,  # å°½é‡å¤šç”Ÿæˆå†…å®¹
                    stream=False
                )
                # è®°å½• DeepSeek API çš„æ€è€ƒç»“æŸæ—¶é—´
                think_end_time = time.time()
                think_duration = think_end_time - think_start_time
                # å¦‚æœ API è¿”å›äº†æ€è€ƒè¿‡ç¨‹åˆ™æ‰“å°ï¼Œå¦åˆ™æç¤ºæ— æ˜¾å¼æ€è€ƒè¿‡ç¨‹
                if hasattr(completion.choices[0].message, "reasoning_content") and completion.choices[0].message.reasoning_content:
                    print(f"ğŸ¤” DeepSeek æ€è€ƒè¿‡ç¨‹ï¼š{completion.choices[0].message.reasoning_content}")
                else:
                    print("ğŸ¤” DeepSeek æ— æ˜¾å¼æ€è€ƒè¿‡ç¨‹")
                print(f"ğŸ¤” DeepSeek æ€è€ƒè€—æ—¶ï¼š{think_duration:.2f}ç§’")
                
                final_answer = completion.choices[0].message.content
                if not final_answer:
                    final_answer = ""

                # åˆ†å‰²æ­£æ–‡å’Œæ¦‚è¦
                parts = final_answer.split("æ¦‚è¦ï¼š")
                if len(parts) != 2:
                    raise ValueError("è¿”å›æ ¼å¼é”™è¯¯ï¼Œæœªæ­£ç¡®åˆ†å‰²æ­£æ–‡å’Œæ¦‚è¦")
                
                main_content = parts[0].replace("æ­£æ–‡ï¼š", "").strip()
                overview_content = parts[1].strip()

                # å†™å…¥æ­£æ–‡åˆ° novel.txt
                with open(NOVEL_FILE, "a", encoding="utf-8") as f:
                    if first_chunk:
                        # ç¬¬ä¸€æ¬¡å†™å…¥æ—¶åŒ…å«ç« èŠ‚æ ‡é¢˜
                        f.write(chapter_title_line + "\n\n" + main_content + "\n\n")
                    else:
                        # åç»­å†™å…¥æ—¶ä»…è¿½åŠ å†…å®¹
                        f.write(main_content + "\n\n")

                # å†™å…¥æ¦‚è¦åˆ° overview.txt
                with open(OVERVIEW_FILE, "a", encoding="utf-8") as f:
                    f.write(overview_content + "\n\n")

                first_chunk = False  # åç»­è°ƒç”¨ä¸å†åŒ…å«æ ‡é¢˜
                break  # å•æ¬¡ç”ŸæˆæˆåŠŸï¼Œè·³å‡ºé‡è¯•å¾ªç¯ï¼Œç»§ç»­æ£€æŸ¥å­—æ•°

            except Exception as e:
                error_message = str(e)
                print(f"âš ï¸ ç« èŠ‚ç”Ÿæˆå¤±è´¥ï¼š{error_message}")

                if "20034" in error_message:  # å¹¶å‘è¶…é™
                    error_counts["20034"] += 1
                    sleep_time_adjust = min(sleep_time * 2, sleep_levels[-1])
                    print(f"âš ï¸ è§¦å‘å¹¶å‘é™åˆ¶ï¼Œå¢åŠ  sleep_time ä¸º {sleep_time_adjust}s")
                    time.sleep(sleep_time_adjust)
                elif "20035" in error_message:  # å†…å®¹è¿‡æ»¤
                    error_counts["20035"] += 1
                    prompt += " è¯·ä¸¥æ ¼é¿å…æ•æ„Ÿå†…å®¹ï¼Œä½¿ç”¨æ›´å§”å©‰çš„è¯­è¨€ã€‚"
                    print("âš ï¸ è§¦å‘å†…å®¹è¿‡æ»¤ï¼Œè°ƒæ•´ prompt åé‡è¯•")
                    time.sleep(10)
                elif "20059" in error_message:  # è¾“å…¥å†…å®¹è¶…é•¿
                    error_counts["20059"] += 1
                    global CONTEXT_LENGTH
                    CONTEXT_LENGTH = max(CONTEXT_LENGTH - 200, 800)
                    print(f"âš ï¸ è§¦å‘è¾“å…¥è¿‡é•¿ï¼Œå‡å°‘ CONTEXT_LENGTH ä¸º {CONTEXT_LENGTH}")
                    time.sleep(10)
                else:
                    print("âš ï¸ æœªçŸ¥é”™è¯¯ï¼Œç¨åé‡è¯•")
                    time.sleep(sleep_time)

                retries += 1

            if retries >= MAX_RETRIES:
                print(f"âš ï¸ é‡è¯• {MAX_RETRIES} æ¬¡ä»æœªæˆåŠŸï¼Œç­‰å¾…åç»§ç»­é‡è¯•æœ¬ç« èŠ‚...")
                time.sleep(sleep_time)
                break

def main():
    while True:
        chapter_number = get_latest_chapter_number()
        if chapter_number > len(CHAPTERS):
            print("âœ… æ‰€æœ‰ç« èŠ‚å·²ç”Ÿæˆå®Œæ¯•ï¼")
            break
        generate_chapter(chapter_number)

if __name__ == "__main__":
    main()